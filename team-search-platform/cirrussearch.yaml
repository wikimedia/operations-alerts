groups:
 - name: cirrussearch
   rules:
    - alert: CirrusSearchJVMGCOldPoolFlatlined
      expr: max_over_time(elasticsearch_jvm_memory_pool_max_bytes{exported_cluster=~"production-search-.*", pool="old"}[1d]) - on (name) min_over_time(elasticsearch_jvm_memory_pool_used_bytes{exported_cluster=~"production-search-.*", pool="old"}[1d]) < 100000000
      for: 1m
      labels:
        team: search-platform
        severity: warning
      annotations:
        summary: "Elasticsearch instance {{$labels.name}} is showing memory pressure in the old pool"
        description: "Elasticsearch is out of memory and will have degraded latency"
        runbook: https://wikitech.wikimedia.org/wiki/Search#Stuck_in_old_GC_hell
        dashboard: https://grafana.wikimedia.org/d/000000462/elasticsearch-memory

    - alert: CirrusSearchHighOldGCFrequency
      expr: increase(elasticsearch_jvm_gc_collection_seconds_count{gc="old"}[1h]) > 60
      for: 5m
      labels:
        team: search-platform
        severity: warning
      annotations:
        summary: "Elasticsearch instance {{$labels.name}} is running the old gc excessively"
        description: "Elasticsearch is out of memory and will have degraded latency"
        runbook: https://wikitech.wikimedia.org/wiki/Search#Stuck_in_old_GC_hell
        dashboard: https://grafana.wikimedia.org/d/000000462/elasticsearch-memory

    - alert: CirrusSearchIndexTooOld
      expr: elasticsearch_indices_age_days{index=~"commonswiki_file|wikidatawiki_content"} > 120
      for: 1m
      labels:
        team: search-platform
        severity: task
      annotations:
        summary: "{{$labels.index}} index in {{$labels.exported_cluster}} is ready for reindexing"
        description: "The reindexing process should be run to ensure multi-lingual analysis chain updates are applied"
