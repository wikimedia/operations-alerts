# https://prometheus.io/docs/prometheus/latest/configuration/unit_testing_rules/
# Test locally using `promtool test rules cirrussearch_test.yaml`
rule_files:
  - cirrussearch.yaml
evaluation_interval: 1m
tests:
  - interval: 1m
    input_series:
      - series: 'elasticsearch_jvm_memory_pool_max_bytes{exported_cluster="production-search-eqiad", pool="old", name="elastic1001-production-search-eqiad"}'
        values: 2200000000 2200000000 2200000000 2200000000 2200000000 2200000000
      - series: 'elasticsearch_jvm_memory_pool_used_bytes{exported_cluster="production-search-eqiad", pool="old", name="elastic1001-production-search-eqiad"}'
        values: 2200000000 2100000000 2200000000 2000000000 2100000000 2200000000
      - series: 'elasticsearch_jvm_memory_pool_max_bytes{exported_cluster="production-search-eqiad", pool="old", name="elastic1002-production-search-eqiad"}'
        values: 2002000000 2002000000 2002000000 2002000000 2002000000 2002000000
      - series: 'elasticsearch_jvm_memory_pool_used_bytes{exported_cluster="production-search-eqiad", pool="old", name="elastic1002-production-search-eqiad"}'
        values: 2000000000 2001000000 2002000000 2000000000 2001000000 2002000000
    alert_rule_test:
      - alertname: CirrusSearchJVMGCOldPoolFlatlined
        eval_time: 10m
        exp_alerts:
          - exp_labels:
              severity: warning
              team: search-platform
              name: elastic1002-production-search-eqiad
            exp_annotations:
              summary: "Elasticsearch instance elastic1002-production-search-eqiad is showing memory pressure in the old pool"
              description: "Elasticsearch is out of memory and will have degraded latency"
              runbook: https://wikitech.wikimedia.org/wiki/Search#Stuck_in_old_GC_hell
              dashboard: https://grafana.wikimedia.org/d/000000462/elasticsearch-memory

  - interval: 1m
    input_series:
      - series: elasticsearch_jvm_gc_collection_seconds_count{exported_cluster="production-search-testing", gc="old", name="elastic1002-production-search-eqiad"}
        values: 0+2x60
    alert_rule_test:
      - alertname: CirrusSearchHighOldGCFrequency
        eval_time: 60m
        exp_alerts:
          - exp_labels:
              severity: warning
              team: search-platform
              name: elastic1002-production-search-eqiad
              gc: old
              exported_cluster: production-search-testing
            exp_annotations:
              summary: "Elasticsearch instance elastic1002-production-search-eqiad is running the old gc excessively"
              description: "Elasticsearch is out of memory and will have degraded latency"
              runbook: https://wikitech.wikimedia.org/wiki/Search#Stuck_in_old_GC_hell
              dashboard: https://grafana.wikimedia.org/d/000000462/elasticsearch-memory

  - interval: 1m
    input_series:
     - series: elasticsearch_indices_age_days{index="commonswiki_file", exported_cluster="alertmanager-test"}
       values: 121
    alert_rule_test:
     - alertname: CirrusSearchIndexTooOld
       eval_time: 1m
       exp_alerts:
        - exp_labels:
            severity: task
            team: search-platform
            index: commonswiki_file
            exported_cluster: alertmanager-test
          exp_annotations:
            summary: "commonswiki_file index in alertmanager-test is ready for reindexing"
            description: "The reindexing process should be run to ensure multi-lingual analysis chain updates are applied"
            runbook: TODO
            dashboard: TODO
