groups:
  - name: traffic
    rules:
      - alert: EdgeTrafficDrop
        expr: >
          round(
            (sum(cluster_layer_code:trafficserver_responses_total:rate5m{cluster="cache_text", layer="tls"}) by (site)) * 100 /
            (sum(cluster_layer_code:trafficserver_responses_total:rate5m{cluster="cache_text", layer="tls"} offset 30m) by (site))
          ) < 70
        for: 1m
        labels:
          team: traffic
          severity: critical
        annotations:
          summary: "{{ $value }}% request drop in text@{{ $externalLabels.site }} during the past 30 minutes"
          description: "Critical if requests percentage difference compared to 30 minutes ago is more than 70%"
          dashboard: "https://grafana.wikimedia.org/d/000000479/frontend-traffic?viewPanel=12&orgId=1&from=now-24h&to=now&var-site={{ $externalLabels.site }}&var-cache_type=text"
          runbook: https://wikitech.wikimedia.org/wiki/Monitoring/EdgeTrafficDrop
      - alert: HAProxyEdgeTrafficDrop
        expr: >
          round(
            (sum(cluster_code:haproxy_frontend_http_responses_total:rate5m{cluster="cache_text"}) by (site)) * 100 /
            (sum(cluster_code:haproxy_frontend_http_responses_total:rate5m{cluster="cache_text"} offset 30m) by (site))
          ) < 70
        for: 1m
        labels:
          team: traffic
          severity: critical
        annotations:
          summary: "{{ $value }}% request drop in text@{{ $externalLabels.site }} during the past 30 minutes"
          description: "Critical if requests percentage difference compared to 30 minutes ago is more than 70%"
          dashboard: "https://grafana.wikimedia.org/d/000000479/frontend-traffic?viewPanel=12&orgId=1&from=now-24h&to=now&var-site={{ $externalLabels.site }}&var-cache_type=text"
          runbook: https://wikitech.wikimedia.org/wiki/Monitoring/EdgeTrafficDrop

      - alert: PyBalBGPUnstable
        expr: pybal_bgp_session_established != 1 and ignoring (local_asn, peer) pybal_bgp_enabled == 1
        for: 5m
        labels:
          team: traffic
          severity: warning
        annotations:
          summary: 'PyBal BGP sessions on instance {{ $labels.instance | reReplaceAll "^([^:]+).*" "${1}" }} are failing'
          description: 'PyBal BGP session establishment with the peer {{ $labels.peer }} is unstable on host {{ $labels.instance | reReplaceAll "^([^:]+).*" "${1}" }}.'
          dashboard: 'https://grafana.wikimedia.org/d/000000488/pybal-bgp?var-datasource={{ $externalLabels.site }}%20prometheus/ops&var-server={{ $labels.instance | reReplaceAll "^([^:]+).*" "${1}" }}'
          runbook: TODO
