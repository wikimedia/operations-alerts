# deploy-tag: ops

groups:
  - name: traffic_haproxykafka
    rules:
      - alert: HaproxyKafkaExporterDown
        annotations:
          summary: 'HaproxyKafka on {{ $labels.instance | stripPort }} is down'
          description: 'HaproxyKafka on {{ $labels.instance | stripPort }} has been down for more than 5 minutes'
          dashboard: 'https://grafana.wikimedia.org/d/d3e4e37c-c1d9-47af-9aad-a08dae2b3fd5/haproxykafka?orgId=1&var-site={{ $externalLabels.site }}&var-instance={{ $labels.instance | stripPort }}'
          runbook: 'https://wikitech.wikimedia.org/wiki/HAProxyKafka#HaproxyKafkaExporterDown'
        expr: up{instance=~"cp[0-9]{4}:9341"} == 0
        for: 5m
        labels:
          team: traffic
          severity: warning
      - alert: HaproxyKafkaExporterDown
        annotations:
          summary: 'HaproxyKafka on {{ $labels.instance | stripPort }} is down'
          description: 'HaproxyKafka on {{ $labels.instance | stripPort }} has been down for more than 1 hour'
          dashboard: 'https://grafana.wikimedia.org/d/d3e4e37c-c1d9-47af-9aad-a08dae2b3fd5/haproxykafka?orgId=1&var-site={{ $externalLabels.site }}&var-instance={{ $labels.instance | stripPort }}'
          runbook: "https://wikitech.wikimedia.org/wiki/HAProxyKafka#HaproxyKafkaExporterDown"
        expr: up{instance=~"cp[0-9]{4}:9341"} == 0
        for: 1h
        labels:
          team: traffic
          severity: critical

      - alert: HaproxyKafkaNoMessages
        expr: '(
          sum by (hostname, cluster) (label_replace (rate(haproxykafka_valid_messages_total{cluster=~"cache_(text|upload)"}[5m]), "hostname", "$1", "instance", "(.*):.*"))
          or
          (sum by (hostname, cluster) (label_replace(up{cluster=~"cache_(text|upload)"} * 0, "hostname", "$1", "instance", "(.*):.*")))
          ) / sum by (hostname, cluster) (label_replace (rate(haproxy_frontend_http_requests_total{cluster=~"cache_(text|upload)"}[5m]), "hostname", "$1", "instance", "(.*):.*")) < 0.2'
        for: 5m
        labels:
          team: traffic
          severity: warning
        annotations:
          summary: 'Unexpected rate of produced HaproxyKafka messages by {{ $labels.hostname }}'
          description: 'Haproxy on {{ $labels.hostname }} is receiving requests, but HaproxyKafka is not sending enough messages'
          dashboard: 'https://grafana.wikimedia.org/d/d3e4e37c-c1d9-47af-9aad-a08dae2b3fd5/haproxykafka?orgId=1&var-site={{ $externalLabels.site }}&var-instance={{ $labels.hostname }}'
          runbook: 'https://wikitech.wikimedia.org/wiki/HAProxyKafka#HaproxyKafkaNoMessages'
      - alert: HaproxyKafkaNoMessages
        expr: '(
          sum by (hostname, cluster) (label_replace (rate(haproxykafka_valid_messages_total{cluster=~"cache_(text|upload)"}[5m]), "hostname", "$1", "instance", "(.*):.*"))
          or
          (sum by (hostname, cluster) (label_replace(up{cluster=~"cache_(text|upload)"} * 0, "hostname", "$1", "instance", "(.*):.*")))
          ) / sum by (hostname, cluster) (label_replace (rate(haproxy_frontend_http_requests_total{cluster=~"cache_(text|upload)"}[5m]), "hostname", "$1", "instance", "(.*):.*")) < 0.1'
        for: 5m
        labels:
          team: traffic
          severity: critical
        annotations:
          summary: 'Unexpected rate of produced HaproxyKafka messages by {{ $labels.hostname }}'
          description: 'Haproxy on {{ $labels.hostname }} is receiving requests, but HaproxyKafka is not sending enough messages'
          dashboard: 'https://grafana.wikimedia.org/d/d3e4e37c-c1d9-47af-9aad-a08dae2b3fd5/haproxykafka?orgId=1&var-site={{ $externalLabels.site }}&var-instance={{ $labels.hostname }}'
          runbook: 'https://wikitech.wikimedia.org/wiki/HAProxyKafka#HaproxyKafkaNoMessages'

      - alert: HaproxyKafkaRestarted
        # In normal conditions, restart count is 0. Alert if it is >= 1.
        expr: 'increase(node_systemd_service_restart_total{name="haproxykafka.service", cluster=~"cache_(text|upload)"}[5m]) > 0'
        labels:
          team: traffic
          severity: critical
        annotations:
          summary: 'HaproxyKafka restarted on {{ $labels.instance }}'
          description: "HaproxyKafka on {{ $labels.instance }} ({{ $externalLabels.site }}) has restarted unexpectedly."
          dashboard: 'https://grafana.wikimedia.org/d/d3e4e37c-c1d9-47af-9aad-a08dae2b3fd5/haproxykafka?orgId=1&var-site={{ $externalLabels.site }}&var-instance={{ $labels.instance | stripPort }}'
          runbook: 'https://wikitech.wikimedia.org/wiki/HAProxyKafka#HaproxyKafkaRestarted'
