# deploy-tag: ops

groups:
  - name: bgp
    rules:
      - alert: CoreRouterInterfaceDown
        expr: |
          (gnmi_interfaces_interface_state_oper_status{instance =~ "(cr|pfw).*"} == 2)
            * on (instance, interface_name, interface_description)
          (gnmi_interfaces_interface_state_enabled{instance =~ "(cr|pfw).*"} == 1)
        for: 2m
        labels:
          team: sre
          severity: critical
          scope: network
        annotations:
          summary: 'Core router interface down - {{ $labels.instance | stripPort }}:{{ $labels.interface_name }} ({{ $labels.interface_description }})'
          description: ''  # Not needed
          dashboard: 'https://grafana.wikimedia.org/d/fb403d62-5f03-434a-9dff-bd02b9fff504/network-device-overview?var-instance={{ $labels.instance }}'
          runbook: 'https://wikitech.wikimedia.org/wiki/Network_monitoring#Router_interface_down'
      - alert: InboundInterfaceErrors
        # When the counter is at 0, the devices don't expose the fcs_errors metric
        # pint disable promql/series
        expr: increase(gnmi_interfaces_interface_state_counters_in_errors[5m]) > 2 or increase(gnmi_interfaces_interface_state_counters_in_fcs_errors[5m]) > 2
        for: 15m
        labels:
          team: dcops
          severity: task
          scope: network
        annotations:
          summary: 'Inbound errors on interface {{ $labels.instance | stripPort }}:{{ $labels.interface_name }} ({{ $labels.interface_description }})'
          description: ''  # Not needed
          dashboard: 'https://grafana.wikimedia.org/d/5p97dAASz/queue-and-error-stats-by-network-device?var-site={{ printf "%s prometheus/ops" $labels.site | urlquery }}&var-device={{ $labels.instance | stripPort }}&var-interface={{ $labels.interface_name | urlquery }}'
          runbook: 'https://wikitech.wikimedia.org/wiki/Network_monitoring#Inbound/outbound_interface_errors'
      - alert: OutboundInterfaceErrors
        # When the counter is at 0, the devices don't expose the out errors
        # pint disable promql/series
        expr: increase(gnmi_interfaces_interface_state_counters_out_errors[5m]) > 2
        for: 15m
        labels:
          team: dcops
          severity: task
          scope: network
        annotations:
          summary: 'Outbound errors on interface {{ $labels.instance | stripPort }}:{{ $labels.interface_name }} ({{ $labels.interface_description }})'
          description: ''  # Not needed
          dashboard: 'https://grafana.wikimedia.org/d/5p97dAASz/queue-and-error-stats-by-network-device?var-site={{ printf "%s prometheus/ops" $labels.site | urlquery }}&var-device={{ $labels.instance | stripPort }}&var-interface={{ $labels.interface_name | urlquery }}'
          runbook: 'https://wikitech.wikimedia.org/wiki/Network_monitoring#Inbound/outbound_interface_errors'
      - alert: TransitPeeringTransportOutSaturation
        expr: |
          (
          irate(gnmi_interfaces_interface_state_counters_out_octets{instance=~"cr.*", interface_description=~"(Transit|Peering|Transport).*"}[5m])
          /
          (gnmi_interfaces_interface_state_high_speed{instance=~"cr.*", interface_description=~"(Transit|Peering|Transport).*"}/8*1000000)
          ) > 0.9
        for: 10m
        labels:
          team: sre
          severity: page
          scope: network
        annotations:
          summary: 'Transit, peering or transport OUT traffic above 90% capacity - {{ $labels.instance | stripPort }}:{{ $labels.interface_name }} ({{ $labels.interface_description }}) #page'
          description: ''  # Not needed
          dashboard: 'https://grafana.wikimedia.org/d/d968a627-b6f6-47fc-9316-e058854a4945/throughput-network-device-interfaces?var-site={{ printf "%s prometheus/ops" $labels.site | urlquery }}&var-device={{ $labels.instance }}&var-interface={{ $labels.interface_name | urlquery }}'
          runbook: 'https://w.wiki/Gbyf'
      - alert: TransitPeeringInSaturation
        expr: |
          (
          irate(gnmi_interfaces_interface_state_counters_in_octets{instance=~"cr.*", interface_description=~"(Transit|Peering).*"}[5m])
          /
          (gnmi_interfaces_interface_state_high_speed{instance=~"cr.*", interface_description=~"(Transit|Peering).*"}/8*1000000)
          ) > 0.9
        for: 10m
        labels:
          team: sre
          severity: page
          scope: network
        annotations:
          summary: 'Transit or peering IN traffic above 90% capacity - {{ $labels.instance | stripPort }}:{{ $labels.interface_name }} ({{ $labels.interface_description }}) #page'
          description: ''  # Not needed
          dashboard: 'https://grafana.wikimedia.org/d/d968a627-b6f6-47fc-9316-e058854a4945/throughput-network-device-interfaces?var-site={{ printf "%s prometheus/ops" $labels.site | urlquery }}&var-device={{ $labels.instance }}&var-interface={{ $labels.interface_name | urlquery }}'
          runbook: 'https://w.wiki/Gbyg'
      - alert: CoreOutboundSaturation
        expr: |
          (
          irate(gnmi_interfaces_interface_state_counters_out_octets{instance=~"(cr|pfw|(f?[lsa]sw)).*", interface_description=~"Core.*"}[5m])
          /
          (gnmi_interfaces_interface_state_high_speed{instance=~"(cr|pfw|(f?[lsa]sw)).*", interface_description=~"Core.*"}/8*1000000)
          ) > 0.9
        for: 10m
        labels:
          team: sre
          severity: page
          scope: network
        annotations:
          summary: 'Core link outbound traffic above 90% capacity - {{ $labels.instance | stripPort }}:{{ $labels.interface_name }} ({{ $labels.interface_description }}) #page'
          description: ''  # Not needed
          dashboard: 'https://grafana.wikimedia.org/d/d968a627-b6f6-47fc-9316-e058854a4945/throughput-network-device-interfaces?var-site={{ printf "%s prometheus/ops" $labels.site | urlquery }}&var-device={{ $labels.instance }}&var-interface={{ $labels.interface_name | urlquery }}'
          runbook: 'https://wikitech.wikimedia.org/wiki/Network_monitoring#Primary_outbound_port_utilization_over_90%'
      - alert: SwitchCoreInterfaceDown
        # eqsin and ulsfo don't have the metrics matching the filters (old switches)
        # To be removed after they're upgraded FY2526
        # pint disable promql/series
        expr: |
          (gnmi_interfaces_interface_state_oper_status{instance =~ "f?[lsa]sw.*", interface_description=~"(Core|Transport):.*"} == 2)
            * on (instance, interface_name, interface_description)
          (gnmi_interfaces_interface_state_enabled{instance =~ "f?[lsa]sw.*", interface_description=~"(Core|Transport):.*"} == 1)
        for: 2m
        labels:
          team: sre
          severity: critical
          scope: network
        annotations:
          summary: 'Switch core interface down - {{ $labels.instance | reReplaceAll "^([^:]+).*" "${1}" }}:{{ $labels.interface_name }} ({{ $labels.interface_description }})'
          description: ''  # Not needed
          dashboard: 'https://grafana.wikimedia.org/d/fb403d62-5f03-434a-9dff-bd02b9fff504/network-device-overview?var-instance={{ $labels.instance }}'
          runbook: 'https://wikitech.wikimedia.org/wiki/Network_monitoring#Switch_interface_down'
      - alert: CoreRouterInterfaceDropPercent
        # the drop stat series are not exported if there is no drops, so we use "or on() vector(0)" to make the expression
        # evaluate to 0 if series not present, so the overall expression can still be evaluated
        expr: |
            (
            ((sum by (instance, interface_name, interface_description, site) (increase(gnmi_interfaces_interface_state_counters_out_queue_red_drop_pkts{instance=~"cr.*", out_queue_queue_number!="1"}[5m])) or on() vector(0)) +
            (sum by (instance, interface_name, interface_description, site) (increase(gnmi_interfaces_interface_state_counters_out_queue_tail_drop_pkts{instance=~"cr.*", out_queue_queue_number!="1"}[5m])) or on() vector(0))) /
            sum by (instance, interface_name, interface_description, site) (increase(gnmi_interfaces_interface_state_counters_out_queue_pkts{instance=~"cr.*", out_queue_queue_number!="1"}[5m]))
            ) > 0.02
        for: 5m
        labels:
          team: sre
          severity: critical
          scope: network
        annotations:
          summary: 'Core router normal + high priority queue drops are high on {{ $labels.instance | stripPort }}:{{ $labels.interface_name }} ({{ $labels.interface_description }})'
          description: ''  # Not needed
          dashboard: 'https://grafana.wikimedia.org/d/5p97dAASz/queue-and-error-stats-by-network-device?var-site={{ printf "%s prometheus/ops" $labels.site | urlquery }}&var-device={{ $labels.instance | stripPort }}&var-interface={{ $labels.interface_name | urlquery }}'
          runbook: 'https://wikitech.wikimedia.org/wiki/Network_monitoring#CoreRouterInterfaceDropPercent'