# deploy-tag: ops

groups:
  - name: resource
    rules:
      - alert: DiskSpace
        # Several fstypes and mount points are excluded by node-exporter - configured in puppet:
        #   - prometheus::node_exporter::ignored_fs_types
        #   - prometheus::node_exporter::ignored_mount_points
        expr: |
          (node_filesystem_avail_bytes{
            fstype!="tmpfs"
          }
          / node_filesystem_size_bytes)
          * on (instance) group_left(team) role_owner < 0.07
        for: 5m
        labels:
          severity: warning
          team: "{{$labels.team}}"
        annotations:
          summary: "Disk space {{$labels.instance}}:{{$labels.mountpoint}} {{ $value | humanizePercentage }} free"
          description: "Disk space {{$labels.instance}}:{{$labels.mountpoint}} ({{$labels.fstype}})"
          dashboard: 'https://grafana.wikimedia.org/d/000000377/host-overview?orgId=1&viewPanel=12&var-server={{ $labels.instance | reReplaceAll "^([^:]+).*" "${1}" }}'
          runbook: https://wikitech.wikimedia.org/wiki/Monitoring/Disk_space

      - alert: DiskSpace
        # Several fstypes and mount points are excluded by node-exporter - configured in puppet:
        #   - prometheus::node_exporter::ignored_fs_types
        #   - prometheus::node_exporter::ignored_mount_points
        expr: |
          (node_filesystem_avail_bytes{
            fstype!="tmpfs"
          }
          / node_filesystem_size_bytes)
          * on (instance) group_left(team) role_owner < 0.04
        for: 5m
        labels:
          severity: critical
          team: "{{$labels.team}}"
        annotations:
          summary: "Disk space {{$labels.instance}}:{{$labels.mountpoint}} {{ $value | humanizePercentage }} free"
          description: "Disk space {{$labels.instance}}:{{$labels.mountpoint}} ({{$labels.fstype}})"
          dashboard: 'https://grafana.wikimedia.org/d/000000377/host-overview?orgId=1&viewPanel=12&var-server={{ $labels.instance | reReplaceAll "^([^:]+).*" "${1}" }}'
          runbook: https://wikitech.wikimedia.org/wiki/Monitoring/Disk_space
