groups:
  - name: puppet-agent
    rules:
    - alert: WidespreadPuppetFailure
      annotations:
        description: Widespread puppet agent failure on {{$labels.cluster}}
        summary: Puppet has failed on {{$labels.cluster}} cluster
        dashboard: https://grafana.wikimedia.org/d/yOxVDGvWk/puppet?orgId=1&viewPanel=3&var-cluster={{$labels.cluster}}
        runbook: https://puppetboard.wikimedia.org/nodes?status=failed
      expr: 'cluster:puppet_agent_failed:sum / cluster:puppet_agent_failed:count >= 0.1'
      labels:
        severity: critical
        team: sre

    - alert: WidespreadPuppetFailure
      annotations:
        description: Widespread puppet agent failure on {{$labels.cluster}} no resources reported
        summary: Puppet has failed on {{$labels.cluster}} cluster no resources reported
        dashboard: https://grafana.wikimedia.org/d/yOxVDGvWk/puppet?orgId=1&viewPanel=3&var-cluster={{$labels.cluster}}
        runbook: https://puppetboard.wikimedia.org/nodes?status=failed
      expr: 'cluster:puppet_agent_resources_total:count0 / cluster:puppet_agent_resources_total:count >= 0.1'
      labels:
        severity: critical
        team: sre

  - name: puppet-agent-fail
    rules:
    # This alert is a crutch on 'alerting' cluster only, until puppet failure
    # alerts are fully ported to AM and issued per-cluster
    # https://phabricator.wikimedia.org/T283151
    - alert: PuppetFailure
      annotations:
        description: Puppet failure on {{$labels.instance}}
        summary: Puppet has failed on alerting hosts
        dashboard: https://grafana.wikimedia.org/d/yOxVDGvWk/puppet
        runbook: https://puppetboard.wikimedia.org/nodes?status=failed
      expr: puppet_agent_failed{cluster="alerting"} > 0 or puppet_agent_resources_total{cluster="alerting"} == 0
      for: 80m # At least two puppet runs
      labels:
        severity: critical
        team: sre

