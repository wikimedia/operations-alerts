# deploy-tag: ops

groups:
  - name: systemd
    rules:
      - alert: SystemdUnitFailed
        # The recording rule will not yield results when there are no units
        # failed (typically in a small site). Therefore disable promql/series
        # check.
        # pint disable promql/series
        expr: |
          instance_name:node_systemd_unit_state_failed:count1
          # wmcs has its own systemdunitdown alerts T333315
          * on (instance) group_left(team) role_owner{team!="wmcs"}
        labels:
          severity: warning
        annotations:
          summary: "{{$labels.name}} Failed on {{$labels.instance}}"
          description: "{{$labels.name}} Failed on {{$labels.instance}}"
          dashboard: 'https://grafana.wikimedia.org/d/g-AaZRFWk/systemd-status'
          runbook: https://wikitech.wikimedia.org/wiki/Monitoring/check_systemd_state

      - alert: SystemdUnitCrashLoop
        expr: |
          increase(node_systemd_service_restart_total[10m])
            * on (instance) group_left(team) role_owner
          > 12 # more than once a minute
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "{{$labels.name}} crashloop on {{$labels.instance}}"
          description: "{{$labels.name}} has had {{ $value }} restarts in the last 10m"
          dashboard: 'https://grafana.wikimedia.org/d/g-AaZRFWk/systemd-status'
          runbook: TODO
