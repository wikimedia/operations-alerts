# deploy-tag: ops
# deploy-site: eqiad, codfw

groups:
  - name: netbox
    rules:
      - &netbox_accounting
        alert: NetboxAccounting
        annotations:
          description: 'Netbox - Accounting job failed'
          summary: 'Netbox - Accounting job failed'
          dashboard: 'https://netbox.wikimedia.org/extras/scripts/12/jobs/'
          runbook: 'https://wikitech.wikimedia.org/wiki/Netbox#Report_Alert'
        expr: sum(delta(netbox_reports_total{name="Accounting"}[10m])) > 0
        labels:
          severity: warning
          team: infrastructure-foundations

      - <<: *netbox_accounting
        alert: NetboxPhysicalHosts
        annotations:
          description: 'Netbox - PhysicalHosts job failed'
          summary: 'Netbox - Report parity errors between PuppetDB and Netbox for physical devices.'
          dashboard: 'https://netbox.wikimedia.org/extras/scripts/18/jobs/'
          runbook: 'https://wikitech.wikimedia.org/wiki/Netbox#Report_Alert'
        expr: sum(delta(netbox_reports_total{name="PhysicalHosts"}[10m])) > 0

      - <<: *netbox_accounting
        alert: NetboxNetwork
        annotations:
          description: 'Netbox - Network test job failed'
          summary: 'Netbox - Report on various network-related errors.'
          dashboard: 'https://netbox.wikimedia.org/extras/scripts/16/jobs/'
          runbook: 'https://wikitech.wikimedia.org/wiki/Netbox#Report_Alert'
        expr: sum(delta(netbox_reports_total{name="Network"}[10m])) > 0

      - <<: *netbox_accounting
        alert: NetboxManagementConsole
        annotations:
          description: 'Netbox - Management Console job failed'
          summary: 'Netbox - All checks related to management/console.'
          dashboard: 'https://netbox.wikimedia.org/extras/scripts/15/jobs/'
          runbook: 'https://wikitech.wikimedia.org/wiki/Netbox#Report_Alert'
        expr: sum(delta(netbox_reports_total{name="ManagementConsole"}[10m])) > 0

      - <<: *netbox_accounting
        alert: NetboxLibreNMS
        annotations:
          description: 'Netbox - LibreNMS job failed'
          summary: 'Netbox - All checks related to LibreNMS.'
          dashboard: 'https://netbox.wikimedia.org/extras/scripts/3/jobs/'
          runbook: 'https://wikitech.wikimedia.org/wiki/Netbox#Report_Alert'
        expr: sum(delta(netbox_reports_total{name="LibreNMS"}[10m])) > 0

      - <<: *netbox_accounting
        alert: NetboxRack
        annotations:
          description: 'Netbox - Rack coherence job failed'
          summary: 'Netbox - Several integrity/coherence checks against the rack related data.'
          dashboard: 'https://netbox.wikimedia.org/extras/scripts/14/jobs/'
          runbook: 'https://wikitech.wikimedia.org/wiki/Netbox#Report_Alert'
        expr: sum(delta(netbox_reports_total{name="Rack"}[10m])) > 0

      - <<: *netbox_accounting
        alert: NetboxCables
        annotations:
          description: 'Netbox - Cable/cable termination job failed'
          summary: 'Netbox - Check that Cables and CableTermination have proper name.'
          dashboard: 'https://netbox.wikimedia.org/extras/scripts/13/jobs/'
          runbook: 'https://wikitech.wikimedia.org/wiki/Netbox#Report_Alert'
        expr: sum(delta(netbox_reports_total{name="Cables"}[10m])) > 0