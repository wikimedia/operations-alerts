rule_files:
- jobqueue.yaml
evaluation_interval: 1m
tests:
- interval: 1m
  input_series:
  # Job1 and Job2 delays have a p95 over 120s.
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job1", le="1"}
    values: "0x30 0x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job1", le="30"}
    values: "0x30 0x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job1", le="60"}
    values: "0x30 0+54x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job1", le="300"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job1", le="+Inf"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_count{rule="low-traffic-jobs-mediawiki-job-Job1"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job2", le="1"}
    values: "0x30 0x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job2", le="30"}
    values: "0x30 0x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job2", le="60"}
    values: "0x30 0+54x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job2", le="300"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job2", le="+Inf"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_count{rule="low-traffic-jobs-mediawiki-job-Job2"}
    values: "0x30 0+60x80"
  # Job3 delays are always short.
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job3", le="1"}
    values: "0x30 0x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job3", le="30"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job3", le="+Inf"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_count{rule="low-traffic-jobs-mediawiki-job-Job3"}
    values: "0x30 0+60x80"
  # Job4 delays have also been short historically, but it's also not currently active (is ignored).
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job4", le="1"}
    values: "0x110"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job4", le="30"}
    values: "60x110"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job4", le="+Inf"}
    values: "60x110"
  - series: cpjobqueue_normal_rule_processing_delay_count{rule="low-traffic-jobs-mediawiki-job-Job4"}
    values: "60x110"
  external_labels:
    site: antarctica
  alert_rule_test:
  - alertname: JobQueueLowTrafficConsumerWidespreadHighLatency
    eval_time: 75m
    exp_alerts: []  # Not firing (too short)
  - alertname: JobQueueLowTrafficConsumerWidespreadHighLatency
    eval_time: 100m
    exp_alerts:
    - exp_labels:
        severity: warning
        team: sre
      exp_annotations:
        summary: "Processing delay times for low-traffic consumer rules are unusually high"
        description: "Processing delay times for low-traffic consumer rules are unusually high in site antarctica for at least 50% of active job types for 1h."
        runbook: TODO
        dashboard: "https://grafana.wikimedia.org/d/LSeAShkGz/jobqueue?var-dc=antarctica%20prometheus/k8s"
- interval: 1m
  input_series:
  # Job1 and Job2 delays are always short.
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job1", le="1"}
    values: "0x30 0x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job1", le="30"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job1", le="+Inf"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_count{rule="low-traffic-jobs-mediawiki-job-Job1"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job2", le="1"}
    values: "0x30 0x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job2", le="30"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job2", le="+Inf"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_count{rule="low-traffic-jobs-mediawiki-job-Job2"}
    values: "0x30 0+60x80"
  # Job3 delays have a p95 over 120s.
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job3", le="1"}
    values: "0x30 0x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job3", le="30"}
    values: "0x30 0x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job3", le="60"}
    values: "0x30 0+54x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job3", le="300"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_bucket{rule="low-traffic-jobs-mediawiki-job-Job3", le="+Inf"}
    values: "0x30 0+60x80"
  - series: cpjobqueue_normal_rule_processing_delay_count{rule="low-traffic-jobs-mediawiki-job-Job3"}
    values: "0x30 0+60x80"
  external_labels:
    site: antarctica
  alert_rule_test:
  - alertname: JobQueueLowTrafficConsumerWidespreadHighLatency
    eval_time: 75m
    exp_alerts: []  # Not firing (too few jobs with high processing delay)
