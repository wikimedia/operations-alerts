rule_files:
  - raid.yaml
evaluation_interval: 1m
tests:
  - interval: 1m
    input_series:
      - series: 'node_md_disks{cluster="backup",device="md0",instance="backup2004:9100",job="node",state="failed"}'
        values: '1x100'
      - series: 'node_md_disks{cluster="backup",device="md0",instance="backup2005:9100",job="node",state="failed"}'
        values: '0x100'
    external_labels:
      site: codfw
    alert_rule_test:
      - alertname: MDRAIDFailedDisk
        eval_time: 15m
        exp_alerts:
          - exp_labels:
              team: infrastructure-foundations
              severity: critical
              job: node
              instance: backup2004:9100
              state: failed
              cluster: backup
              device: md0
            exp_annotations:
              description: 'md raid degraded on backup2004:9100'
              summary: 'MD RAID - Failed disk(s)'
              dashboard: 'TODO'
              runbook: 'https://wikitech.wikimedia.org/wiki/Dc-operations/Hardware_Troubleshooting_Runbook#Hardware_Raid_Information_Gathering'

  - interval: 1m
    input_series:
      - series: 'node_md_disks{cluster="backup",device="md0",instance="backup2004:9100",job="node",state="active"}'
        values: '1x100'
      - series: 'node_md_disks{cluster="backup",device="md0",instance="backup2005:9100",job="node",state="active"}'
        values: '2x100'
    external_labels:
      site: codfw
    alert_rule_test:
      - alertname: MDRAIDNotEnoughDisks
        eval_time: 15m
        exp_alerts:
          - exp_labels:
              team: infrastructure-foundations
              severity: critical
              job: node
              instance: backup2004:9100
              state: active
              cluster: backup
              device: md0
            exp_annotations:
              description: 'md raid degraded on backup2004:9100'
              summary: 'MD RAID - insufficient active disk(s)'
              dashboard: 'TODO'
              runbook: 'https://wikitech.wikimedia.org/wiki/Dc-operations/Hardware_Troubleshooting_Runbook#Hardware_Raid_Information_Gathering'
