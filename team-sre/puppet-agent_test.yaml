rule_files:
  - puppet-agent.yaml
evaluation_interval: 1m
tests:
  - interval: 1m
    input_series:
      - series: 'cluster:puppet_agent_failed:sum{cluster="misc"}'
        values: '10'
      - series: 'cluster:puppet_agent_failed:count{cluster="misc"}'
        values: '100'
    alert_rule_test:
    - alertname: WidespreadPuppetFailure
      eval_time: 1m
      exp_alerts:
       - exp_labels:
           severity: critical
           team: sre
           cluster: misc
         exp_annotations:
           summary: 'Puppet has failed on misc cluster'
           description: 'Widespread puppet agent failure on misc'
           dashboard: 'https://grafana.wikimedia.org/d/yOxVDGvWk/puppet?orgId=1&viewPanel=3&var-cluster=misc'
           runbook: https://puppetboard.wikimedia.org/nodes?status=failed

  - interval: 1m
    input_series:
      - series: 'cluster:puppet_agent_resources_total:count0{cluster="misc"}'
        values: '10'
      - series: 'cluster:puppet_agent_resources_total:count{cluster="misc"}'
        values: '100'
    alert_rule_test:
    - alertname: WidespreadPuppetFailure
      eval_time: 1m
      exp_alerts:
       - exp_labels:
           severity: critical
           team: sre
           cluster: misc
         exp_annotations:
           summary: 'Puppet has failed on misc cluster no resources reported'
           description: 'Widespread puppet agent failure on misc no resources reported'
           dashboard: 'https://grafana.wikimedia.org/d/yOxVDGvWk/puppet?orgId=1&viewPanel=3&var-cluster=misc'
           runbook: https://puppetboard.wikimedia.org/nodes?status=failed

  - interval: 1m
    input_series:
      - series: 'puppet_agent_failed{cluster="alerting",instance="alert1001:9100"}'
        values: '0+1x90'
    alert_rule_test:
    - alertname: PuppetFailure
      eval_time: 90m
      exp_alerts:
       - exp_labels:
           severity: critical
           team: sre
           instance: alert1001:9100
           cluster: alerting
         exp_annotations:
           summary: Puppet has failed on alerting hosts
           description: 'Puppet failure on alert1001:9100'
           dashboard: https://grafana.wikimedia.org/d/yOxVDGvWk/puppet
           runbook: https://puppetboard.wikimedia.org/nodes?status=failed
