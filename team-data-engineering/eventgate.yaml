# We do not want to alert on this in staging at the moment
# deploy-tag: k8s
groups:
  - name: eventgate
    rules:

## Eventgate Logging Latency alerts
    - alert: EventgateLoggingExternalLatency
      annotations:
        description: Critical latency for 90th percentile of {{ $labels.method }} method events on eventgate-logging-external in {{ $externalLabels.site }}.
        summary: Critical latency for {{ $labels.method }} events on eventgate-logging-external in {{ $externalLabels.site }}.
        dashboard: https://grafana.wikimedia.org/d/ZB39Izmnz/eventgate?viewPanel=79&orgId=1&var-service=eventgate-logging-external
        runbook: https://wikitech.wikimedia.org/wiki/Event_Platform/EventGate
      expr: service_method:express_router_request_duration_seconds:90pct5m{service="eventgate-logging-external"} > 1
      for: 5m
      labels:
        severity: critical
        team: data-engineering

    - alert: EventgateLoggingExternalLatency
      annotations:
        description: Elevated latency for 90th percentile of {{ $labels.method }} method events on eventgate-logging-external in {{ $externalLabels.site }}.
        summary: Elevated latency for {{ $labels.method }} events on eventgate-logging-external in {{ $externalLabels.site }}.
        dashboard: https://grafana.wikimedia.org/d/ZB39Izmnz/eventgate?viewPanel=79&orgId=1&var-service=eventgate-logging-external
        runbook: https://wikitech.wikimedia.org/wiki/Event_Platform/EventGate
      expr: service_method:express_router_request_duration_seconds:90pct5m{service="eventgate-logging-external"} > 0.98
      for: 5m
      labels:
        severity: warning
        team: data-engineering

## Eventgate Services Validation Error Alerts
    - alert: EventgateValidationErrors
      annotations:
        description: Eventgate-main stream {{ $labels.stream }} validation errors detected in past 15 min
        summary: Eventgate-main stream {{ $labels.stream }} validation errors detected in past 15 min
        dashboard: https://grafana.wikimedia.org/d/ZB39Izmnz/eventgate?orgId=1&refresh=1m&var-service=eventgate-main&var-stream=All&var-kafka_broker=All&var-kafka_producer_type=All&var-dc=thanos
        runbook: https://wikitech.wikimedia.org/wiki/Event_Platform/EventGate
      expr: sum by (stream) (rate(eventgate_validation_errors_total{service="eventgate-main"} [15m])) > 0.5
      labels:
        severity: critical
        team: data-engineering

    # No stats for this metric when checked, but adding to mirror Icinga config
    - alert: EventgateValidationErrors
      annotations:
        description: Eventgate-analytics stream {{ $labels.stream }} validation errors detected in past 15 min
        summary: Eventgate-analytics stream {{ $labels.stream }} validation errors detected in past 15 min
        dashboard: https://grafana.wikimedia.org/d/ZB39Izmnz/eventgate?orgId=1&refresh=1m&var-service=eventgate-analytics&var-stream=All&var-kafka_broker=All&var-kafka_producer_type=All&var-dc=thanos
        runbook: https://wikitech.wikimedia.org/wiki/Event_Platform/EventGate
      expr: sum by (stream) (rate(eventgate_validation_errors_total{service="eventgate-analytics"} [15m])) > 1
      labels:
        severity: critical
        team: data-engineering

    - alert: EventgateValidationErrors
      annotations:
        description: Eventgate-analytics-external stream {{ $labels.stream }} validation errors detected in past 15 min
        summary: Eventgate-analytics-external stream {{ $labels.stream }} validation errors detected in past 15 min
        dashboard: https://grafana.wikimedia.org/d/ZB39Izmnz/eventgate?orgId=1&refresh=1m&var-service=eventgate-analytics-external&var-stream=All&var-kafka_broker=All&var-kafka_producer_type=All&var-dc=thanos
        runbook: https://wikitech.wikimedia.org/wiki/Event_Platform/EventGate
      expr: sum by (stream) (rate(eventgate_validation_errors_total{service="eventgate-analytics-external"} [15m])) > 2
      labels:
        severity: critical
        team: data-engineering

    - alert: EventgateValidationErrors
      annotations:
        description: Eventgate-logging-external stream {{ $labels.stream }} validation errors detected in past 15 min
        summary: Eventgate-logging-external stream {{ $labels.stream }} validation errors detected in past 15 min
        dashboard: https://grafana.wikimedia.org/d/ZB39Izmnz/eventgate?orgId=1&refresh=1m&var-service=eventgate-logging-external&var-stream=All&var-kafka_broker=All&var-kafka_producer_type=All&var-dc=thanos
        runbook: https://wikitech.wikimedia.org/wiki/Event_Platform/EventGate
      expr: sum by (stream) (rate(eventgate_validation_errors_total{service="eventgate-logging-external"} [15m])) > 0.5
      labels:
        severity: critical
        team: data-engineering
